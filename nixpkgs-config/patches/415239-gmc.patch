From a35490b72db1b186c82b63bf2b1fc4d692eba45a Mon Sep 17 00:00:00 2001
From: "R. Ryantm" <ryantm-bot@ryantm.com>
Date: Sun, 8 Jun 2025 11:18:05 +0000
Subject: [PATCH 1/2] geminicommit: 0.4.0 -> 0.4.1

---
 pkgs/by-name/ge/geminicommit/package.nix | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/pkgs/by-name/ge/geminicommit/package.nix b/pkgs/by-name/ge/geminicommit/package.nix
index ff58bebd43bdc1..2b69183918c9dd 100644
--- a/pkgs/by-name/ge/geminicommit/package.nix
+++ b/pkgs/by-name/ge/geminicommit/package.nix
@@ -8,16 +8,16 @@
 
 buildGoModule (finalAttrs: {
   pname = "geminicommit";
-  version = "0.4.0";
+  version = "0.4.1";
 
   src = fetchFromGitHub {
     owner = "tfkhdyt";
     repo = "geminicommit";
     tag = "v${finalAttrs.version}";
-    hash = "sha256-hJevJkniyICUUr1UyS0A5SKuuYRU0dGHMWzF99Yr2Eo=";
+    hash = "sha256-QUI5JI1udOo3IOXegoes3pwwgSfxXIjxXIPsA5SuAJo=";
   };
 
-  vendorHash = "sha256-IfqlPg+HPcOfjlwwuLi2/R21UD83xQzWyUmzM7JSDEs=";
+  vendorHash = "sha256-AFm+1RQ6sMSe+kY/cw1Ly/8WEj2/yk0nJQiEJzV6jKg=";
 
   nativeBuildInputs = [
     installShellFiles

From 827ec2499b454f104f9fbef86b81ba0267cea74e Mon Sep 17 00:00:00 2001
From: Bryan Lai <bryanlais@gmail.com>
Date: Mon, 9 Jun 2025 17:09:44 +0800
Subject: [PATCH 2/2] geminicommit: rename mainProgram & add versionCheckHook

---
 pkgs/by-name/ge/geminicommit/package.nix | 22 +++++++++++++++++++---
 1 file changed, 19 insertions(+), 3 deletions(-)

diff --git a/pkgs/by-name/ge/geminicommit/package.nix b/pkgs/by-name/ge/geminicommit/package.nix
index 2b69183918c9dd..2c83ac9c285aeb 100644
--- a/pkgs/by-name/ge/geminicommit/package.nix
+++ b/pkgs/by-name/ge/geminicommit/package.nix
@@ -4,6 +4,7 @@
   fetchFromGitHub,
   installShellFiles,
   stdenv,
+  versionCheckHook,
 }:
 
 buildGoModule (finalAttrs: {
@@ -26,9 +27,18 @@ buildGoModule (finalAttrs: {
   postInstall =
     let
       cmd = finalAttrs.meta.mainProgram;
+      goDefaultCmd = finalAttrs.pname;
     in
-    lib.optionalString (with stdenv; buildPlatform.canExecute hostPlatform) ''
-      # `geminicommit` requires write permissions to $HOME for its `config.toml`
+    # The official github released binary is renamed since v0.4.1,
+    # see: https://github.com/tfkhdyt/geminicommit/releases/tag/v0.4.1
+    # Here we link the old name (which is also the `go build` default name)
+    # for backward compatibility:
+    ''
+      mv $out/bin/${goDefaultCmd} $out/bin/${cmd}
+      ln -s $out/bin/${cmd} $out/bin/${goDefaultCmd}
+    ''
+    + lib.optionalString (with stdenv; buildPlatform.canExecute hostPlatform) ''
+      # `gmc` requires write permissions to $HOME for its `config.toml`
       # ... which is automatically initiated on startup
       export HOME=$(mktemp -d)
 
@@ -39,11 +49,17 @@ buildGoModule (finalAttrs: {
       done
     '';
 
+  nativeInstallCheckInputs = [
+    versionCheckHook
+  ];
+
+  doInstallCheck = true;
+
   meta = {
     description = "CLI that generates git commit messages with Google Gemini AI";
     homepage = "https://github.com/tfkhdyt/geminicommit";
     license = lib.licenses.gpl3Only;
     maintainers = with lib.maintainers; [ bryango ];
-    mainProgram = "geminicommit";
+    mainProgram = "gmc";
   };
 })
