#!/bin/bash
# get the position of a package

CODE_VIEWER="@viewer@"

if [[ $# -gt 1 ]]; then
    CODE_VIEWER=$1
    shift
fi

package=$1
shift

IFS=" " read -r -a pos <<< "$(
    package=$package "@pkgsposition@" --raw --apply toString | xargs
)"
relative=${pos[0]}
nixpkgs=${pos[1]}

>&2 echo "## relative: $relative"
>&2 echo "## nixpkgs: $nixpkgs"

## replace ":$line:..." with "#L$line"
hashline=$(sed -E 's/:([0-9]+)(:[0-9]*)*$/#L\1/g' <<< "$relative")
>&2 echo "## online: https://github.com/NixOS/nixpkgs/blob/master/$hashline"
>&2 echo ""

exec $CODE_VIEWER "$nixpkgs/$relative" "$nixpkgs"
