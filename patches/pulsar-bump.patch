From 486bfe3d16a322110f04c3bab51d1af9885aa78c Mon Sep 17 00:00:00 2001
From: Peder Bergebakken Sundt <pbsds@hotmail.com>
Date: Tue, 24 Sep 2024 23:48:07 +0200
Subject: [PATCH 1/2] pulsar: 1.120.0 -> 1.121.0

Changelog: https://github.com/pulsar-edit/pulsar/blob/v1.121.0/CHANGELOG.md
---
 pkgs/by-name/pu/pulsar/001-patch-wrapper.patch | 11 -----------
 pkgs/by-name/pu/pulsar/package.nix             | 16 +++++++---------
 2 files changed, 7 insertions(+), 20 deletions(-)
 delete mode 100644 pkgs/by-name/pu/pulsar/001-patch-wrapper.patch

diff --git a/pkgs/by-name/pu/pulsar/001-patch-wrapper.patch b/pkgs/by-name/pu/pulsar/001-patch-wrapper.patch
deleted file mode 100644
index 2270ad3c8aea879..000000000000000
--- a/pkgs/by-name/pu/pulsar/001-patch-wrapper.patch
+++ /dev/null
@@ -1,11 +0,0 @@
---- a/resources/pulsar.sh	2023-03-16 04:11:14.000000000 +0100
-+++ b/resources/pulsar.sh	2023-03-24 14:37:13.468813964 +0100
-@@ -123,7 +123,7 @@
- elif [ $OS == 'Linux' ]; then
-   SCRIPT=$(readlink -f "$0")
- 
--  PULSAR_PATH="/opt/Pulsar/pulsar"
-+  # PULSAR_PATH is set-up via `wrapProgram` in the postFixup phase
- 
-   #Set tmpdir only if tmpdir is unset
-   : ${TMPDIR:=/tmp}
diff --git a/pkgs/by-name/pu/pulsar/package.nix b/pkgs/by-name/pu/pulsar/package.nix
index 1f7123e468b7cf2..690215395065589 100644
--- a/pkgs/by-name/pu/pulsar/package.nix
+++ b/pkgs/by-name/pu/pulsar/package.nix
@@ -7,6 +7,7 @@
 , alsa-lib
 , at-spi2-atk
 , cairo
+, coreutils
 , cups
 , dbus
 , expat
@@ -34,13 +35,13 @@
 
 let
   pname = "pulsar";
-  version = "1.120.0";
+  version = "1.121.0";
 
   sourcesPath = {
     x86_64-linux.tarname = "Linux.${pname}-${version}.tar.gz";
-    x86_64-linux.hash = "sha256-35/ZMi6YsXs27icV3kXuKl3Kl8IHLLYbV0aO49qMJ2Q=";
+    x86_64-linux.hash = "sha256-xouxKl4GTNZkT5wn8qbG2W2PbVAbsK9povmIL/Mikk4=";
     aarch64-linux.tarname = "ARM.Linux.${pname}-${version}-arm64.tar.gz";
-    aarch64-linux.hash = "sha256-N1CAWeBHePd2KnnePEJQnvIKfIxal1RQ5UB8pxpVJCk=";
+    aarch64-linux.hash = "sha256-qRBX8jO5xDXkZ/6TWkgNa1NS3l+z8K/JyJDAa/3me5Q=";
   }.${stdenv.hostPlatform.system} or (throw "Unsupported system: ${stdenv.hostPlatform.system}");
 
   newLibpath = lib.makeLibraryPath [
@@ -86,10 +87,6 @@ stdenv.mkDerivation {
     inherit hash;
   };
 
-  patches = [
-    ./001-patch-wrapper.patch
-  ];
-
   nativeBuildInputs = [
     wrapGAppsHook3
     copyDesktopItems
@@ -187,10 +184,11 @@ stdenv.mkDerivation {
     asar p $asarBundle $opt/resources/app.asar
     rm -rf $asarBundle
 
-    # We have patched the original wrapper, but now it needs the "PULSAR_PATH" env var
+    # Pulsar uses `PULSAR_PATH` to know where it is intalled
     mkdir -p $out/bin
     wrapProgram $opt/resources/pulsar.sh \
-      --prefix "PULSAR_PATH" : "$opt/pulsar"
+      --suffix "PATH" : "${lib.makeBinPath [ coreutils ]}" \
+      --set "PULSAR_PATH" "$opt"
     ln -s $opt/resources/pulsar.sh $out/bin/pulsar
     ln -s $opt/resources/app/ppm/bin/apm $out/bin/ppm
 

From fc121a1c5764ac8f253240974e0e7ef6463f055c Mon Sep 17 00:00:00 2001
From: Peder Bergebakken Sundt <pbsds@hotmail.com>
Date: Wed, 25 Sep 2024 01:01:24 +0200
Subject: [PATCH 2/2] pulsar: add pbsds to meta.maintainers

---
 pkgs/by-name/pu/pulsar/package.nix | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/pkgs/by-name/pu/pulsar/package.nix b/pkgs/by-name/pu/pulsar/package.nix
index 690215395065589..83b1d4416a7fded 100644
--- a/pkgs/by-name/pu/pulsar/package.nix
+++ b/pkgs/by-name/pu/pulsar/package.nix
@@ -228,7 +228,7 @@ stdenv.mkDerivation {
     sourceProvenance = with lib.sourceTypes; [ binaryNativeCode ];
     license = lib.licenses.mit;
     platforms = lib.platforms.linux;
-    maintainers = with lib.maintainers; [ bryango ];
+    maintainers = with lib.maintainers; [ bryango pbsds ];
     knownVulnerabilities = [
       # electron 12.2.3, efforts are in place to bump it
       "CVE-2023-5217"
